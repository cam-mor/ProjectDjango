{% load static %}

<div class="card mb-4" id="comments-section" data-group-id="{{ group.id }}">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">
            <i class="fas fa-comments"></i> Discussion
            <span class="badge bg-primary">{{ comments.count }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'core:add_comment' group.id %}" class="mb-4">
            {% csrf_token %}
            <div class="mb-3">
                <textarea name="content" class="form-control" rows="3" placeholder="Join the discussion..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Post Comment
            </button>
        </form>
        {% else %}
        <div class="alert alert-info">
            Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a> to join the discussion.
        </div>
        {% endif %}

        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment mb-3" id="comment-{{ comment.id }}" data-comment-id="{{ comment.id }}">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <img src="{% static 'core/images/default-avatar.png' %}" class="rounded-circle" width="40" height="40" alt="{{ comment.author.username }}">
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ comment.author.username }}</h6>
                                <small class="text-muted">
                                    {{ comment.created_at|timesince }} ago
                                    {% if comment.is_edited %}
                                    <span class="text-muted">(edited)</span>
                                    {% endif %}
                                </small>
                            </div>
                            {% if user == comment.author %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item edit-comment-btn" href="#" data-comment-id="{{ comment.id }}">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                    </li>
                                    <li>
                                        <form method="post" action="{% url 'core:delete_comment' group.id comment.id %}" class="d-inline delete-comment-form">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        <div class="comment-content mt-2">
                            {{ comment.content|linebreaks }}
                        </div>
                        {% if user.is_authenticated %}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-link reply-btn" data-comment-id="{{ comment.id }}">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        </div>
                        {% endif %}
                        
                        <!-- Replies -->
                        {% if comment.replies.exists %}
                        <div class="replies mt-3 ms-4">
                            {% for reply in comment.replies.all %}
                            <div class="reply mb-2" id="reply-{{ reply.id }}">
                                <!-- Similar structure to comment, but indented -->
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <img src="{% static 'core/images/default-avatar.png' %}" class="rounded-circle" width="30" height="30" alt="{{ reply.author.username }}">
                                    </div>
                                    <div class="flex-grow-1 ms-2">
                                        <h6 class="mb-1">{{ reply.author.username }}</h6>
                                        <small class="text-muted">{{ reply.created_at|timesince }} ago</small>
                                        <div class="mt-1">
                                            {{ reply.content|linebreaks }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted">
                <p>No comments yet. Be the first to start the discussion!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const groupId = document.getElementById('comments-section').dataset.groupId;
    const addReplyUrlTemplate = "{% url 'core:add_reply' group.id 0 %}";
    const editCommentUrlTemplate = "{% url 'core:edit_comment' group.id 0 %}";
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Reply button handlers
    document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.dataset.commentId;
            showReplyForm(commentId);
        });
    });

    // Edit button handlers
    document.querySelectorAll('.edit-comment-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.dataset.commentId;
            editComment(commentId);
        });
    });

    // Delete form handlers
    document.querySelectorAll('.delete-comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                e.preventDefault();
            }
        });
    });

    function showReplyForm(commentId) {
        const commentElement = document.getElementById(`comment-${commentId}`);
        if (commentElement.querySelector('.reply-form')) return;

        const form = document.createElement('form');
        form.method = 'post';
        form.action = addReplyUrlTemplate.replace('/0', `/${commentId}`);
        form.className = 'mt-2 reply-form';

        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
            <div class="mb-2">
                <textarea name="content" class="form-control form-control-sm" rows="2" placeholder="Write a reply..." required></textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">Reply</button>
            <button type="button" class="btn btn-sm btn-link cancel-reply-btn">Cancel</button>
        `;

        form.querySelector('.cancel-reply-btn').addEventListener('click', () => form.remove());
        commentElement.querySelector('.comment-content').insertAdjacentElement('afterend', form);
    }

    function editComment(commentId) {
        const commentElement = document.getElementById(`comment-${commentId}`);
        const contentElement = commentElement.querySelector('.comment-content');
        if (commentElement.querySelector('.edit-form')) return;

        const currentContent = contentElement.textContent.trim();
        const originalHtml = contentElement.innerHTML;

        const form = document.createElement('form');
        form.method = 'post';
        form.action = editCommentUrlTemplate.replace('/0', `/${commentId}`);
        form.className = 'mt-2 edit-form';

        form.innerHTML = `
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
            <div class="mb-2">
                <textarea name="content" class="form-control" rows="3" required>${currentContent}</textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">Save Changes</button>
            <button type="button" class="btn btn-sm btn-link cancel-edit-btn">Cancel</button>
        `;

        form.querySelector('.cancel-edit-btn').addEventListener('click', () => {
            contentElement.innerHTML = originalHtml;
        });

        contentElement.innerHTML = '';
        contentElement.appendChild(form);
    }
});
</script>
{% endblock %}