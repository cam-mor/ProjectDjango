{% extends 'core/base.html' %}
{% block title %}Estadísticas{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-4">
  <h1 class="me-3">Estadísticas</h1>
  <span class="text-muted">Visión general de la plataforma</span>
</div>

<form method="get" class="row g-3 mb-4 align-items-end">
  <div class="col-12 col-md-4">
    <label class="form-label">Grupo (opcional)</label>
    <select class="form-select" name="group">
      <option value="">Global</option>
      {% for g in groups %}
        <option value="{{ g.id }}" {% if current_group and current_group.id == g.id %}selected{% endif %}>{{ g.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">Desde</label>
    <input type="date" class="form-control" name="from" value="{{ filter_start }}">
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">Hasta</label>
    <input type="date" class="form-control" name="to" value="{{ filter_end }}">
  </div>
  <div class="col-12 col-md-4 d-flex gap-2">
    <div class="btn-group" role="group">
      <a class="btn btn-outline-secondary" href="?preset=4w{% if current_group %}&group={{ current_group.id }}{% endif %}">4w</a>
      <a class="btn btn-outline-secondary" href="?preset=8w{% if current_group %}&group={{ current_group.id }}{% endif %}">8w</a>
      <a class="btn btn-outline-secondary" href="?preset=12w{% if current_group %}&group={{ current_group.id }}{% endif %}">12w</a>
      <a class="btn btn-outline-secondary" href="?preset=26w{% if current_group %}&group={{ current_group.id }}{% endif %}">26w</a>
      <a class="btn btn-outline-secondary" href="?{% if current_group %}group={{ current_group.id }}{% endif %}">Reset</a>
    </div>
    <button class="btn btn-primary" type="submit">Aplicar</button>
    <a class="btn btn-outline-success" href="{% url 'core:stats_export' %}?from={{ filter_start }}&to={{ filter_end }}{% if current_group %}&group={{ current_group.id }}{% endif %}">
      <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
    </a>
    {% if current_group %}
    <a class="btn btn-outline-secondary" href="{% url 'core:stats_export_top' %}?from={{ filter_start }}&to={{ filter_end }}&group={{ current_group.id }}">
      <i class="bi bi-trophy"></i> Exportar Top Miembros
    </a>
    {% endif %}
  </div>
</form>

<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Usuarios</div>
            <div class="h4 mb-0">{{ total_users }}</div>
          </div>
          <i class="bi bi-people h2 text-primary"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Grupos</div>
            <div class="h4 mb-0">{{ total_groups }}</div>
          </div>
          <i class="bi bi-collection h2 text-success"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Sesiones</div>
            <div class="h4 mb-0">{{ total_sessions }}</div>
          </div>
          <i class="bi bi-calendar3 h2 text-info"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Horas estudiadas</div>
            <div class="h4 mb-0">{{ total_study_hours }}</div>
          </div>
          <i class="bi bi-hourglass-split h2 text-warning"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted">Materiales</div>
        <div class="h5">{{ total_materials }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted">Comentarios</div>
        <div class="h5">{{ total_comments }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted">Usuarios activos (30 días)</div>
        <div class="h5">{{ active_users_30d }}</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Horas por semana (12 semanas)</strong></div>
      <div class="card-body" style="height: 280px;">
        <canvas id="hoursPerWeek"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Sesiones por semana (12 semanas)</strong></div>
      <div class="card-body" style="height: 280px;">
        <canvas id="sessionsPerWeek"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Nuevos {{ month_series_label|lower }} por mes (6 meses)</strong></div>
      <div class="card-body" style="height: 280px;">
        <canvas id="usersPerMonth"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Dispersión: hora de inicio vs duración</strong></div>
      <div class="card-body" style="height: 280px;">
        <canvas id="scatterDuration"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Distribución de duraciones</strong></div>
      <div class="card-body" style="height: 280px;">
        <canvas id="histDuration"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const charts = JSON.parse('{{ charts_json|escapejs }}');

  const hoursCtx = document.getElementById('hoursPerWeek').getContext('2d');
  new Chart(hoursCtx, {
    type: 'line',
    data: {
      labels: charts.week_labels,
      datasets: [{
        label: 'Horas',
        data: charts.hours_per_week,
        borderColor: 'rgba(255, 159, 64, 1)',
        backgroundColor: 'rgba(255, 159, 64, 0.2)',
        tension: 0.3,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: { legend: { display: true } }
    }
  });

  const sessionsCtx = document.getElementById('sessionsPerWeek').getContext('2d');
  new Chart(sessionsCtx, {
    type: 'bar',
    data: {
      labels: charts.week_labels,
      datasets: [{
        label: 'Sesiones',
        data: charts.sessions_per_week,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        y: { beginAtZero: true, precision: 0 }
      },
      plugins: { legend: { display: true } }
    }
  });

  const usersCtx = document.getElementById('usersPerMonth').getContext('2d');
  new Chart(usersCtx, {
    type: 'bar',
    data: {
      labels: charts.month_labels,
      datasets: [{
        label: 'Usuarios',
        data: charts.users_per_month,
        backgroundColor: 'rgba(75, 192, 192, 0.6)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        y: { beginAtZero: true, precision: 0 }
      }
    }
  });

  const scatterCtx = document.getElementById('scatterDuration').getContext('2d');
  new Chart(scatterCtx, {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Sesiones',
        data: charts.scatter_points,
        backgroundColor: 'rgba(153, 102, 255, 0.6)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: { 
          type: 'linear', 
          min: 0, 
          max: 24,
          title: { display: true, text: 'Hora de inicio' }
        },
        y: { 
          beginAtZero: true,
          title: { display: true, text: 'Duración (h)' }
        }
      }
    }
  });

  const histCtx = document.getElementById('histDuration').getContext('2d');
  new Chart(histCtx, {
    type: 'bar',
    data: {
      labels: charts.hist_labels,
      datasets: [{
        label: 'Sesiones',
        data: charts.hist_counts,
        backgroundColor: 'rgba(255, 99, 132, 0.6)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: { 
        y: { beginAtZero: true }
      },
      plugins: { legend: { display: true } }
    }
  });
</script>
{% endblock %}
