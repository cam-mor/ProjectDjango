{% extends 'core/base.html' %}
{% block title %}Mis Estadísticas{% endblock %}
{% block content %}
<div class="d-flex align-items-center mb-4">
  <h1 class="me-3">Mis Estadísticas</h1>
  <span class="text-muted">Tus sesiones de estudio y progreso</span>
</div>

<form method="get" class="row g-3 mb-4 align-items-end">
  <div class="col-6 col-md-3">
    <label class="form-label">Desde</label>
    <input type="date" class="form-control" name="from" value="{{ filter_start }}">
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">Hasta</label>
    <input type="date" class="form-control" name="to" value="{{ filter_end }}">
  </div>
  <div class="col-12 col-md-6 d-flex gap-2">
    <div class="btn-group" role="group">
      <a class="btn btn-outline-secondary" href="?preset=4w">4w</a>
      <a class="btn btn-outline-secondary" href="?preset=8w">8w</a>
      <a class="btn btn-outline-secondary" href="?preset=12w">12w</a>
      <a class="btn btn-outline-secondary" href="?preset=26w">26w</a>
      <a class="btn btn-outline-secondary" href="?">Reset</a>
    </div>
    <button class="btn btn-primary" type="submit">Aplicar</button>
  </div>
</form>

<div class="row g-3 mb-4">
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Mis Sesiones</div>
            <div class="h4 mb-0">{{ total_my_sessions }}</div>
          </div>
          <i class="bi bi-calendar-check h2 text-primary"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Horas Estudiadas</div>
            <div class="h4 mb-0">{{ my_study_hours }}</div>
          </div>
          <i class="bi bi-hourglass-split h2 text-warning"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Mis Grupos</div>
            <div class="h4 mb-0">{{ total_groups }}</div>
          </div>
          <i class="bi bi-people h2 text-success"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white"><strong>Mis horas por semana</strong></div>
      <div class="card-body">
        <canvas id="hoursPerWeek" style="height: 250px;"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white"><strong>Mis sesiones por semana</strong></div>
      <div class="card-body">
        <canvas id="sessionsPerWeek" style="height: 250px;"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Sesiones por grupo</strong></div>
      <div class="card-body">
        <canvas id="groupSessions" style="height: 250px;"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Hora de inicio vs Duración</strong></div>
      <div class="card-body">
        <canvas id="scatterDuration" style="height: 250px;"></canvas>
        <div class="text-muted small mt-2">Cada punto representa una sesión de estudio</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Distribución de duraciones</strong></div>
      <div class="card-body">
        <canvas id="histDuration" style="height: 250px;"></canvas>
        <div class="text-muted small mt-2">Cantidad de sesiones por rango de duración</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const charts = JSON.parse('{{ charts_json|escapejs }}');

  // Horas por semana (Line chart)
  const hoursCtx = document.getElementById('hoursPerWeek').getContext('2d');
  new Chart(hoursCtx, {
    type: 'line',
    data: {
      labels: charts.week_labels,
      datasets: [{
        label: 'Horas',
        data: charts.hours_per_week,
        borderColor: 'rgba(255, 159, 64, 1)',
        backgroundColor: 'rgba(255, 159, 64, 0.2)',
        tension: 0.3,
        fill: true,
        borderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      },
      plugins: { 
        legend: { display: true },
        tooltip: { mode: 'index', intersect: false }
      }
    }
  });

  // Sesiones por semana (Bar chart)
  const sessionsCtx = document.getElementById('sessionsPerWeek').getContext('2d');
  new Chart(sessionsCtx, {
    type: 'bar',
    data: {
      labels: charts.week_labels,
      datasets: [{
        label: 'Sesiones',
        data: charts.sessions_per_week,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { 
          beginAtZero: true, 
          ticks: { precision: 0, stepSize: 1 }
        }
      },
      plugins: { legend: { display: true } }
    }
  });

  // Sesiones por grupo (Bar chart)
  const groupCtx = document.getElementById('groupSessions').getContext('2d');
  new Chart(groupCtx, {
    type: 'bar',
    data: {
      labels: charts.group_labels,
      datasets: [{
        label: 'Sesiones',
        data: charts.group_sessions,
        backgroundColor: 'rgba(75, 192, 192, 0.7)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      scales: {
        x: { 
          beginAtZero: true,
          ticks: { precision: 0, stepSize: 1 }
        }
      },
      plugins: { legend: { display: false } }
    }
  });

  // Scatter: hora de inicio vs duración
  const scatterCtx = document.getElementById('scatterDuration').getContext('2d');
  new Chart(scatterCtx, {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Sesiones',
        data: charts.scatter_points,
        backgroundColor: 'rgba(153, 102, 255, 0.6)',
        borderColor: 'rgba(153, 102, 255, 1)',
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          type: 'linear', 
          min: 0, 
          max: 24,
          ticks: { stepSize: 2 },
          title: { display: true, text: 'Hora de inicio (0-24h)' }
        },
        y: { 
          beginAtZero: true,
          title: { display: true, text: 'Duración (horas)' }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Inicio: ${context.parsed.x.toFixed(1)}h, Duración: ${context.parsed.y.toFixed(2)}h`;
            }
          }
        }
      }
    }
  });

  // Histograma: distribución de duraciones
  const histCtx = document.getElementById('histDuration').getContext('2d');
  new Chart(histCtx, {
    type: 'bar',
    data: {
      labels: charts.hist_labels,
      datasets: [{
        label: 'Cantidad de sesiones',
        data: charts.hist_counts,
        backgroundColor: 'rgba(255, 99, 132, 0.7)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { precision: 0, stepSize: 1 }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.parsed.y} sesiones`;
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
